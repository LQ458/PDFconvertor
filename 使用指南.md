# PDFé¢„å¤„ç†æœåŠ¡ - ä½¿ç”¨æŒ‡å—

## ğŸš€ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åº”ç”¨è®¾è®¡çš„PDFé¢„å¤„ç†æœåŠ¡ï¼Œå¯ä»¥å°†PDFæ–‡ä»¶è½¬æ¢ä¸ºç»“æ„åŒ–çš„æ–‡æœ¬å—å’Œå‘é‡åµŒå…¥ã€‚

**âœ¨ ä¸»è¦ç‰¹æ€§ï¼š**
- ğŸ”§ æ”¯æŒå¤šç§å¼€æºEmbeddingæ¨¡å‹ï¼ˆæ— éœ€OpenAI APIï¼‰
- ğŸ“š ä¸“é—¨ä¼˜åŒ–ä¸­æ–‡æ•™æå¤„ç†
- ğŸ§¹ æ™ºèƒ½æ–‡æœ¬æ¸…ç†å’Œè´¨é‡æ£€æµ‹
- ğŸ“Š å¤šç§è¾“å‡ºæ ¼å¼ï¼ˆJSONã€LangChainã€OpenAIæ ¼å¼ï¼‰
- ğŸš€ é«˜æ•ˆæ‰¹é‡å¤„ç†
- ğŸŒ RESTful APIæ¥å£

## ğŸ“ é¡¹ç›®ç»“æ„

```
PDFconvertor/
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ services/          # æ ¸å¿ƒæœåŠ¡
â”‚   â”‚   â””â”€â”€ pdfProcessor.ts # PDFå¤„ç†å’Œembeddingç”Ÿæˆ
â”‚   â”œâ”€â”€ routes/            # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ health.ts      # å¥åº·æ£€æŸ¥
â”‚   â”‚   â”œâ”€â”€ pdfProcessor.ts # PDFå¤„ç†API
â”‚   â”‚   â””â”€â”€ upload.ts      # æ–‡ä»¶ä¸Šä¼ API
â”‚   â”œâ”€â”€ middleware/        # ä¸­é—´ä»¶
â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”œâ”€â”€ scripts/               # æ‰¹å¤„ç†è„šæœ¬
â”‚   â””â”€â”€ batch-process-textbooks.js # æ‰¹é‡å¤„ç†æ•™æ
â”œâ”€â”€ output/                # å¤„ç†è¾“å‡º
â”œâ”€â”€ temp/                  # ä¸´æ—¶æ–‡ä»¶
â”œâ”€â”€ models_cache/          # æ¨¡å‹ç¼“å­˜ç›®å½•
â”œâ”€â”€ 01.å°å­¦.å…¨å¥—æ•™æ/       # å°å­¦æ•™æ (591ä¸ªPDF)
â”œâ”€â”€ 02.åˆä¸­.å…¨å¥—æ•™æ/       # åˆä¸­æ•™æ
â””â”€â”€ dist/                  # ç¼–è¯‘è¾“å‡º
```

## ğŸ¤– æ”¯æŒçš„Embeddingæ¨¡å‹

### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ä¼˜åŒ–æ¨¡å‹
- **bge-large-zh-v1.5** (æ¨è) - 1024ç»´ï¼Œé«˜è´¨é‡ä¸­æ–‡ç†è§£
- **bge-base-zh-v1.5** - 768ç»´ï¼Œæ€§èƒ½ä¸æ•ˆç‡å¹³è¡¡
- **bge-m3** - 1024ç»´ï¼Œå¤šè¯­è¨€é•¿æ–‡æœ¬æ”¯æŒ

### ğŸ‡ºğŸ‡¸ è‹±æ–‡æ¨¡å‹
- **all-mpnet-base-v2** - 768ç»´ï¼Œé«˜è´¨é‡è‹±æ–‡æ¨¡å‹
- **all-MiniLM-L12-v2** - 384ç»´ï¼Œä¸­ç­‰è§„æ¨¡
- **all-MiniLM-L6-v2** - 384ç»´ï¼Œè½»é‡çº§é«˜é€Ÿ

### ğŸŒ å¤šè¯­è¨€æ¨¡å‹
- **gte-qwen2-1.5b** - 1536ç»´ï¼Œé˜¿é‡Œå·´å·´æœ€æ–°å¤šè¯­è¨€æ¨¡å‹

## âš™ï¸ ç¯å¢ƒé…ç½®

### 1. å®‰è£…ä¾èµ–
```bash
pnpm install
```

### 2. ç¯å¢ƒå˜é‡ (.env)
```env
# Embeddingæ¨¡å‹é…ç½®
EMBEDDING_MODEL=bge-large-zh-v1.5
GENERATE_EMBEDDINGS=true

# æœåŠ¡é…ç½®
PORT=3001
NODE_ENV=development

# è¾“å‡ºé…ç½®
OUTPUT_DIR=./output
TEMP_DIR=./temp

# å‘é‡åŒ–é…ç½®
CHUNK_SIZE=2000
CHUNK_OVERLAP=400
MAX_CHUNKS_PER_DOCUMENT=500

# æ¨¡å‹ç¼“å­˜é…ç½®
HF_HOME=./models_cache
TRANSFORMERS_CACHE=./models_cache
```

### 3. æ¨¡å‹é€‰æ‹©å»ºè®®
```bash
# ä¸­æ–‡æ•™æï¼ˆæ¨èï¼‰
EMBEDDING_MODEL=bge-large-zh-v1.5

# è‹±æ–‡æ–‡æ¡£
EMBEDDING_MODEL=all-mpnet-base-v2

# å¤šè¯­è¨€æ–‡æ¡£
EMBEDDING_MODEL=bge-m3

# å¿«é€Ÿå¤„ç†ï¼ˆè½»é‡çº§ï¼‰
EMBEDDING_MODEL=all-MiniLM-L6-v2
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨æœåŠ¡
```bash
# æ„å»ºé¡¹ç›®
pnpm run build

# å¯åŠ¨æœåŠ¡
pnpm start

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:3001/api/health
```

### 2. æŸ¥çœ‹æ”¯æŒçš„æ¨¡å‹
```bash
curl http://localhost:3001/api/pdf/models
```

### 3. å•æ–‡ä»¶å¤„ç†
```bash
# ä¸Šä¼ PDFæ–‡ä»¶å¹¶ç”Ÿæˆembedding
curl -X POST \
  -F "pdf=@your-file.pdf" \
  -F "generateEmbeddings=true" \
  http://localhost:3001/api/pdf/upload

# åªæå–æ–‡æœ¬ï¼Œä¸ç”Ÿæˆembedding
curl -X POST \
  -F "pdf=@your-file.pdf" \
  -F "generateEmbeddings=false" \
  http://localhost:3001/api/pdf/upload
```

### 4. æ‰¹é‡å¤„ç†æ•™æ
```bash
# å¤„ç†æ‰€æœ‰æ•™ææ–‡ä»¶
node scripts/batch-process-textbooks.js

# å¤„ç†ç‰¹å®šç›®å½•
node scripts/batch-process-textbooks.js --dir "01.å°å­¦.å…¨å¥—æ•™æ"
```

### 5. è·å–å¤„ç†ç»“æœ
```bash
# åˆ—å‡ºæ‰€æœ‰å¤„ç†è¿‡çš„æ–‡æ¡£
curl http://localhost:3001/api/pdf/list

# è·å–ç‰¹å®šæ–‡æ¡£æ•°æ®
curl http://localhost:3001/api/pdf/data/[filename]

# å¯¼å‡ºä¸ºä¸åŒæ ¼å¼
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"files": ["file1.json", "file2.json"]}' \
  http://localhost:3001/api/pdf/export/langchain
```

## ğŸ“Š è¾“å‡ºæ ¼å¼

### 1. åŸå§‹JSONæ ¼å¼
```json
{
  "filename": "document.pdf",
  "totalPages": 10,
  "totalChunks": 25,
  "chunks": [
    {
      "content": "æ–‡æœ¬å†…å®¹",
      "metadata": {
        "page": 1,
        "chunkIndex": 0,
        "source": "document.pdf"
      },
      "embedding": [0.1, 0.2, ...]
    }
  ],
  "processingStats": {
    "embeddingModel": "bge-large-zh-v1.5",
    "processingDate": "2024-01-01T00:00:00Z"
  }
}
```

### 2. LangChainæ ¼å¼
```json
{
  "documents": [
    {
      "pageContent": "åˆå¹¶çš„æ–‡æœ¬å†…å®¹",
      "metadata": {
        "filename": "document.pdf",
        "totalPages": 10,
        "embeddingModel": "bge-large-zh-v1.5"
      }
    }
  ]
}
```

## ğŸ” æ–‡æœ¬è´¨é‡æ£€æµ‹

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹é—®é¢˜ï¼š
- ğŸ“ **æ–‡æœ¬æ¸…ç†**ï¼šç§»é™¤å‡ºç‰ˆç¤¾ä¿¡æ¯ã€ä½œè€…ä¿¡æ¯ç­‰
- ğŸ” **ä¹±ç æ£€æµ‹**ï¼šæ ‡è®°å¯èƒ½éœ€è¦äººå·¥å®¡æ ¸çš„æ–‡æ¡£
- ğŸ“Š **è´¨é‡è¯„ä¼°**ï¼šæä¾›æ–‡æœ¬è´¨é‡è¯„åˆ†

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ¨¡å‹é€‰æ‹©å»ºè®®
- **é«˜è´¨é‡**ï¼šbge-large-zh-v1.5 (1024ç»´)
- **å¹³è¡¡**ï¼šbge-base-zh-v1.5 (768ç»´)
- **é«˜é€Ÿ**ï¼šall-MiniLM-L6-v2 (384ç»´)

### æ‰¹å¤„ç†ä¼˜åŒ–
```bash
# è°ƒæ•´å¹¶å‘æ•°é‡
export CONCURRENT_LIMIT=3

# è°ƒæ•´å—å¤§å°
export CHUNK_SIZE=1500
export CHUNK_OVERLAP=300
```

## ğŸ”— RAGåº”ç”¨é›†æˆ

### 1. Webhooké€šçŸ¥
```env
RAG_WEBHOOK_URL=http://localhost:3000/api/webhook/processed-documents
RAG_API_KEY=your_api_key
```

### 2. è½®è¯¢è·å–
```bash
# å®šæœŸæ£€æŸ¥æ–°å¤„ç†çš„æ–‡æ¡£
curl http://localhost:3001/api/pdf/list?type=processed
```

### 3. ç›´æ¥APIè°ƒç”¨
```javascript
// è·å–å¤„ç†åçš„æ•°æ®
const response = await fetch('/api/pdf/export/langchain', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ files: ['doc1.json', 'doc2.json'] })
});
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡å‹ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®ä¿æœ‰è¶³å¤Ÿç£ç›˜ç©ºé—´
   - åˆ é™¤ `models_cache` ç›®å½•é‡è¯•

2. **å†…å­˜ä¸è¶³**
   - ä½¿ç”¨è½»é‡çº§æ¨¡å‹ï¼š`all-MiniLM-L6-v2`
   - å‡å°‘å¹¶å‘å¤„ç†æ•°é‡
   - è°ƒæ•´å—å¤§å°å‚æ•°

3. **PDFè§£æå¤±è´¥**
   - æ£€æŸ¥PDFæ–‡ä»¶å®Œæ•´æ€§
   - ç¡®è®¤æ–‡ä»¶æƒé™
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
curl http://localhost:3001/api/pdf/status

# æŸ¥çœ‹æ—¥å¿—
tail -f batch-processing.log

# æ£€æŸ¥æ¨¡å‹ç¼“å­˜
ls -la models_cache/
```

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§
- æœåŠ¡å¥åº·æ£€æŸ¥ï¼š`/api/health`
- å¤„ç†çŠ¶æ€ï¼š`/api/pdf/status`
- å†…å­˜ä½¿ç”¨ï¼šåŒ…å«åœ¨å¥åº·æ£€æŸ¥ä¸­

### å®šæœŸç»´æŠ¤
```bash
# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf temp/*

# æ¸…ç†è¿‡æœŸè¾“å‡º
find output -name "*.json" -mtime +30 -delete

# é‡å»ºæ¨¡å‹ç¼“å­˜
rm -rf models_cache && pnpm start
```

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ğŸ“‹ æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—
2. ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®
3. ğŸ’¾ ç£ç›˜ç©ºé—´å’Œå†…å­˜
4. ğŸŒ ç½‘ç»œè¿æ¥ï¼ˆé¦–æ¬¡ä¸‹è½½æ¨¡å‹ï¼‰

---

**ğŸ‰ ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨å®Œå…¨å¼€æºçš„embeddingæ¨¡å‹å¤„ç†PDFæ–‡æ¡£äº†ï¼** 